<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sign In • Aurora Auctions</title>
  <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
<header class="site">
  <div class="inner">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>Aurora Auctions</h1>
    </div>
    <nav>
      <a href="/index.html">Home</a>
      <a href="/pages/browse.html">Browse</a>
      <a href="/pages/sell.html">Sell</a>
      <a href="/pages/profile.html">Profile</a>
      <a href="/pages/login.html" id="loginLink">Sign In</a>
      <button class="btn" id="logoutBtn" style="display:none">Sign Out</button>
    </nav>
  </div>
</header>

<main class="container">
  <section class="card" style="max-width:600px;margin:0 auto">
    <h2>Sign In</h2>
    <div class="input">
      <label for="u">Username</label>
      <input id="u" placeholder="e.g. armaan2" autocomplete="username">
    </div>
    <div class="input">
      <label for="p">Password</label>
      <input id="p" type="password" placeholder="••••••••" autocomplete="current-password">
    </div>
    <button class="btn primary" id="go">Sign In</button>
    <p class="helper">Forgot Password? (placeholder)</p>
  </section>
</main>

<footer>
  <div>© 2025 Aurora Auctions — Front-end demo. API is proxied via <span class="kbd">/api/*</span>.</div>
</footer>

<script type="module">
  // Minimal nav state (no DemoAPI.signIn — we call /api/auth/login directly)
  function navActive(){
    const here = location.pathname.split('/').pop();
    document.querySelectorAll('nav a').forEach(a=>{
      if(a.getAttribute('href').endsWith(here)) a.classList.add('active');
    });
  }
  navActive();

  const loginLink = document.getElementById('loginLink');
  const logoutBtn = document.getElementById('logoutBtn');

  function currentUser(){
    try { return JSON.parse(localStorage.getItem('SESSION_USER')||'null'); } catch { return null; }
  }
  function setAuthed(token, user){
    localStorage.setItem('AUTH_TOKEN', token);
    localStorage.setItem('SESSION_USER', JSON.stringify(user));
  }
  function clearAuthed(){
    localStorage.removeItem('AUTH_TOKEN');
    localStorage.removeItem('SESSION_USER');
  }

  // Initialize header state
  const uinfo = currentUser();
  if(uinfo){
    loginLink.textContent = uinfo.username;
    loginLink.href = '/pages/profile.html';
    logoutBtn.style.display = 'inline-flex';
  }
  logoutBtn.addEventListener('click', ()=>{
    clearAuthed();
    location.href = '/index.html';
  });

  // Handle sign-in
  const uEl = document.getElementById('u');
  const pEl = document.getElementById('p');
  const go  = document.getElementById('go');

  async function signIn(){
    const username = uEl.value.trim();
    const password = pEl.value;
    if(!username || !password){
      alert('Please enter both username and password.');
      return;
    }
    try{
      const res = await fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || `Login failed (HTTP ${res.status})`);
      }
      const { token, user } = await res.json();
      setAuthed(token, user);
      // Optional: verify the token by calling /api/auth/me (debug)
      // await fetch('/api/auth/me', { headers: { 'Authorization': 'Bearer ' + token }});
      location.href = '/pages/browse.html';
    }catch(err){
      alert(err.message || 'Login failed');
    }
  }

  go.addEventListener('click', signIn);
  // Enter key submits
  [uEl, pEl].forEach(el => el.addEventListener('keydown', e=>{
    if(e.key === 'Enter') signIn();
  }));
</script>
</body>
</html>
