<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Aurora Auctions • Minimal Client</title>
</head>
<body>
  <h1>Aurora Auctions • Minimal Client</h1>
  <p>API: <b>http://100.75.75.20:8080</b></p>

  <h2>Auth</h2>
  <div>
    <h3>Create account</h3>
    <div style="display:grid;gap:.25rem;max-width:440px">
      <label>Username <input id="regUsername" autocomplete="username"></label>
      <label>First name <input id="regFirstName"></label>
      <label>Last name <input id="regLastName"></label>
      <label>Email <input id="regEmail" type="email" autocomplete="email"></label>
      <label>Phone <input id="regPhone" type="tel" placeholder="+1 555-555-5555"></label>
      <label>Password <input id="regPassword" type="password" autocomplete="new-password"></label>
      <label>Confirm password <input id="regPassword2" type="password" autocomplete="new-password"></label>
      <button id="registerBtn">Create</button>
    </div>
  </div>

  <div style="margin-top:1rem">
    <h3>Sign in</h3>
    <label>Email or Username <input id="loginId" autocomplete="username"></label>
    <label>Password <input id="loginPassword" type="password" autocomplete="current-password"></label>
    <button id="loginBtn">Sign in</button>
    <button id="logoutBtn">Sign out</button>
    <div>Auth: <span id="authStatus">Not signed in</span></div>
    <pre id="meOut" style="white-space:pre-wrap"></pre>
  </div>

  <hr>

  <h2>Sell an item (Create auction)</h2>
  <div style="display:grid;gap:.35rem;max-width:560px">
    <label>Title <input id="auTitle" maxlength="120" placeholder="e.g., RTX 4090"></label>
    <label>Description <textarea id="auDesc" rows="4" placeholder="Condition, accessories, notes"></textarea></label>
    <label>Type
      <select id="auType">
        <option value="FORWARD">FORWARD (highest bid wins)</option>
        <option value="DUTCH">DUTCH (price ticks down)</option>
      </select>
    </label>

    <!-- Shared -->
    <label>Ends at <input id="auEndsAt" type="datetime-local"></label>
    <label>Currency <input id="auCurrency" value="CAD"></label>

    <!-- FORWARD fields -->
    <div id="forwardFields">
      <label>Starting price <input id="auStartPrice" type="number" step="0.01" placeholder="e.g., 100.00"></label>
      <label>Min bid increment <input id="auMinInc" type="number" step="0.01" placeholder="e.g., 1.00"></label>
      <label>Reserve price (optional) <input id="auReserve" type="number" step="0.01"></label>
      <label>Buyout price (optional) <input id="auBuyout" type="number" step="0.01"></label>
    </div>

    <!-- DUTCH fields -->
    <div id="dutchFields" style="display:none">
      <label>Start price <input id="duStart" type="number" step="0.01" placeholder="e.g., 500.00"></label>
      <label>Floor price <input id="duFloor" type="number" step="0.01" placeholder="e.g., 200.00"></label>
      <label>Step amount (price drop) <input id="duStep" type="number" step="0.01" placeholder="e.g., 5.00"></label>
      <label>Step interval (seconds) <input id="duEvery" type="number" step="1" placeholder="e.g., 60"></label>
    </div>

    <button id="createAuctionBtn">Create auction</button>
    <pre id="sellOut"></pre>
  </div>

  <hr>

  <h2>Auctions</h2>
  <button id="listAuctionsBtn">List active auctions</button>
  <pre id="auctionsOut"></pre>

  <h3>Place bid (FORWARD)</h3>
  <label>Auction ID <input id="fAuctionId"></label>
  <label>Amount <input id="fAmount" type="number" step="0.01"></label>
  <button id="fBidBtn">Bid</button>
  <pre id="fBidOut"></pre>

  <h3>Accept price (DUTCH)</h3>
  <label>Auction ID <input id="dAuctionId"></label>
  <button id="dAcceptBtn">Accept current price</button>
  <pre id="dAcceptOut"></pre>

  <h3>End auction</h3>
  <label>Auction ID <input id="endAuctionId"></label>
  <button id="endAuctionBtn">End now</button>
  <pre id="endOut"></pre>

  <h2>Payment (mock)</h2>
  <label>Order ID <input id="payOrderId"></label>
  <label>Amount <input id="payAmount" type="number" step="0.01"></label>
  <label>Provider
    <select id="payProvider">
      <option value="MOCK">MOCK</option>
      <option value="CASH">CASH</option>
      <option value="CARD">CARD</option>
    </select>
  </label>
  <button id="payBtn">Pay</button>
  <pre id="payOut"></pre>

  <h3>Receipt</h3>
  <div id="receipt" style="white-space:pre-wrap;"></div>
  <button id="printBtn">Print receipt</button>

  <hr>
  <h2>Console</h2>
  <pre id="consoleOut"></pre>

<script>
const BASE_URL = "http://100.75.75.20:8080";
let token = localStorage.getItem('AA_JWT') || null;

const el = (id)=>document.getElementById(id);
const els = {
  authStatus: el('authStatus'),
  meOut: el('meOut'),
  auctionsOut: el('auctionsOut'),
  fBidOut: el('fBidOut'),
  dAcceptOut: el('dAcceptOut'),
  endOut: el('endOut'),
  payOut: el('payOut'),
  receipt: el('receipt'),
  consoleOut: el('consoleOut'),
  sellOut: el('sellOut'),
  forwardFields: el('forwardFields'),
  dutchFields: el('dutchFields'),
};

function log(msg, obj){
  const ts = new Date().toISOString();
  let line = `[${ts}] ${msg}`;
  if (obj !== undefined) line += `\n${JSON.stringify(obj,null,2)}\n`;
  els.consoleOut.textContent = line + '\n' + els.consoleOut.textContent;
}
function setAuth(){ els.authStatus.textContent = token ? 'Signed in' : 'Not signed in'; }

async function request(path, opts={}){
  const headers = opts.headers || {};
  headers['Content-Type'] = 'application/json';
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const res = await fetch(`${BASE_URL}${path}`, {
    method: opts.method || 'GET',
    headers,
    body: opts.body ? JSON.stringify(opts.body): undefined
  });
  const text = await res.text();
  let json; try{ json = text ? JSON.parse(text) : null; } catch{ json = {raw:text}; }
  if (!res.ok) throw {status:res.status, body:json};
  return json;
}

/* Helpers */
const required = (v)=>v!=null && String(v).trim().length>0;
const toISO = (dtLocal)=> dtLocal ? new Date(dtLocal).toISOString() : null;

/* Toggle forward/dutch specific fields */
el('auType').addEventListener('change', ()=>{
  const t = el('auType').value;
  els.forwardFields.style.display = (t==='FORWARD') ? '' : 'none';
  els.dutchFields.style.display = (t==='DUTCH') ? '' : 'none';
});

/* ===== Auth: Register/Login/Logout ===== */
el('registerBtn').onclick = async ()=>{
  try{
    const username   = el('regUsername').value.trim();
    const firstName  = el('regFirstName').value.trim();
    const lastName   = el('regLastName').value.trim();
    const email      = el('regEmail').value.trim();
    const phone      = el('regPhone').value.trim();
    const password   = el('regPassword').value;
    const password2  = el('regPassword2').value;

    if (![username,firstName,lastName,email,phone,password,password2].every(required)) {
      alert('All fields are required.'); return;
    }
    if (password !== password2){ alert('Passwords do not match.'); return; }
    if (password.length < 8){ alert('Password must be at least 8 characters.'); return; }

    const payload = { username, firstName, lastName, email, phone, password };
    const data = await request('/api/auth/register', {method:'POST', body: payload});
    log('Registered', data);
    alert('Account created.');
  }catch(e){
    log('Register failed', e);
    alert(e?.status===409 ? 'Email/username already exists.' : 'Register failed.');
  }
};

el('loginBtn').onclick = async ()=>{
  try{
    const loginId  = el('loginId').value.trim();
    const password = el('loginPassword').value;
    if (!required(loginId) || !required(password)){ alert('Login and password required'); return; }

    let data;
    try {
      data = await request('/api/auth/login', {method:'POST', body:{ login: loginId, password }});
    } catch (e1){
      try { data = await request('/api/auth/login', {method:'POST', body:{ email: loginId, password }}); }
      catch(e2){ throw e1; }
    }

    token = data.token || data.accessToken || null;
    if(!token) throw {status:500, body:'No token returned'};
    localStorage.setItem('AA_JWT', token);
    setAuth();
    log('Login ok', {tokenPreview: token.slice(0,16)+'...'});
    await refreshMe();
  }catch(e){ log('Login failed', e); alert('Login failed.'); }
};

el('logoutBtn').onclick = ()=>{
  token = null;
  localStorage.removeItem('AA_JWT');
  setAuth();
  els.meOut.textContent = '';
  log('Logged out');
};

async function refreshMe(){
  if (!token){ els.meOut.textContent=''; return; }
  try{
    const me = await request('/api/auth/me');
    els.meOut.textContent = JSON.stringify(me, null, 2);
  }catch(e){
    els.meOut.textContent = 'Unable to fetch profile (/api/auth/me).';
    log('Fetch /me failed', e);
  }
}

/* ===== Sell: Create auction =====
   Endpoint: POST /api/auctions
   Payload (FORWARD example):
   {
     "title","description","type":"FORWARD","currency",
     "startingPrice", "minIncrement", "reservePrice", "buyoutPrice",
     "endsAt"
   }
   Payload (DUTCH example):
   {
     "title","description","type":"DUTCH","currency",
     "startPrice","floorPrice","stepAmount","stepSeconds",
     "endsAt"
   }
*/
el('createAuctionBtn').onclick = async ()=>{
  try{
    if (!token){ alert('Sign in first.'); return; }

    const title = el('auTitle').value.trim();
    const description = el('auDesc').value.trim();
    const type = el('auType').value;
    const endsAtLocal = el('auEndsAt').value;
    const currency = (el('auCurrency').value || 'CAD').trim().toUpperCase();

    if (!required(title) || !required(type) || !required(endsAtLocal)) {
      alert('Title, Type, and Ends at are required.'); return;
    }

    const endsAt = toISO(endsAtLocal);

    let payload = { title, description, type, currency, endsAt };

    if (type === 'FORWARD'){
      const startingPrice = parseFloat(el('auStartPrice').value);
      const minIncrement  = parseFloat(el('auMinInc').value);
      const reservePrice  = el('auReserve').value ? parseFloat(el('auReserve').value) : null;
      const buyoutPrice   = el('auBuyout').value ? parseFloat(el('auBuyout').value) : null;

      if (isNaN(startingPrice) || isNaN(minIncrement)){
        alert('Starting price and Min increment are required for FORWARD.'); return;
      }
      payload.startingPrice = startingPrice;
      payload.minIncrement  = minIncrement;
      if (!isNaN(reservePrice)) payload.reservePrice = reservePrice;
      if (!isNaN(buyoutPrice))  payload.buyoutPrice  = buyoutPrice;
    } else { // DUTCH
      const startPrice = parseFloat(el('duStart').value);
      const floorPrice = parseFloat(el('duFloor').value);
      const stepAmount = parseFloat(el('duStep').value);
      const stepSeconds = parseInt(el('duEvery').value,10);

      if ([startPrice,floorPrice,stepAmount,stepSeconds].some(v=>isNaN(v))){
        alert('All Dutch fields are required.'); return;
      }
      payload.startPrice  = startPrice;
      payload.floorPrice  = floorPrice;
      payload.stepAmount  = stepAmount;
      payload.stepSeconds = stepSeconds;
    }

    const created = await request('/api/auctions', { method:'POST', body: payload });
    els.sellOut.textContent = JSON.stringify(created, null, 2);
    log('Auction created', created);
    alert('Auction created.');
  }catch(e){
    els.sellOut.textContent = 'Create auction failed.';
    log('Create auction failed', e);
    if (e?.status === 401) alert('Unauthorized. Sign in and try again.');
  }
};

/* ===== Browse/List ===== */
el('listAuctionsBtn').onclick = async ()=>{
  try{
    const data = await request('/api/auctions?state=ACTIVE');
    els.auctionsOut.textContent = JSON.stringify(data,null,2);
  }catch(e){ els.auctionsOut.textContent='Error.'; log('List auctions failed', e); }
};

/* ===== Forward bid ===== */
el('fBidBtn').onclick = async ()=>{
  const id = el('fAuctionId').value.trim();
  const amount = parseFloat(el('fAmount').value);
  if(!id || isNaN(amount)){ alert('Auction ID and amount required'); return; }
  try{
    const data = await request(`/api/auctions/${encodeURIComponent(id)}/bids`, {
      method:'POST',
      body:{ amount }
    });
    els.fBidOut.textContent = JSON.stringify(data,null,2);
  }catch(e){ els.fBidOut.textContent='Bid failed.'; log('Forward bid failed', e); }
};

/* ===== Dutch accept ===== */
el('dAcceptBtn').onclick = async ()=>{
  const id = el('dAuctionId').value.trim();
  if(!id){ alert('Auction ID required'); return; }
  try{
    const data = await request(`/api/auctions/${encodeURIComponent(id)}/accept`, { method:'POST' });
    els.dAcceptOut.textContent = JSON.stringify(data,null,2);
  }catch(e){ els.dAcceptOut.textContent='Accept failed.'; log('Dutch accept failed', e); }
};

/* ===== End auction ===== */
el('endAuctionBtn').onclick = async ()=>{
  const id = el('endAuctionId').value.trim();
  if(!id){ alert('Auction ID required'); return; }
  try{
    const data = await request(`/api/auctions/${encodeURIComponent(id)}/end`, { method:'POST' });
    els.endOut.textContent = JSON.stringify(data,null,2);
    if (data && data.orderId){ el('payOrderId').value = data.orderId; }
  }catch(e){ els.endOut.textContent='End failed.'; log('End auction failed', e); }
};

/* ===== Payment (mock) ===== */
el('payBtn').onclick = async ()=>{
  const orderId = parseInt(el('payOrderId').value,10);
  const amount = parseFloat(el('payAmount').value);
  const provider = String(el('payProvider').value || 'MOCK').toUpperCase();
  if(isNaN(orderId) || isNaN(amount)){ alert('Order ID and amount required'); return; }
  try{
    const data = await request('/api/payments', {
      method:'POST',
      body:{ orderId, amount, provider }
    });
    els.payOut.textContent = JSON.stringify(data,null,2);
    const receipt = {
      title: 'Aurora Auctions — Receipt',
      datetime: new Date().toISOString(),
      orderId, amount, provider,
      paymentId: data.paymentId || data.id || '(unknown)',
      status: data.status || 'SUCCEEDED',
      note: 'Mock payment — no real funds transferred.'
    };
    els.receipt.textContent = JSON.stringify(receipt,null,2);
  }catch(e){ els.payOut.textContent='Payment failed.'; log('Payment failed', e); }
};

/* Print receipt */
el('printBtn').onclick = ()=>{
  const w = window.open('', 'PRINT', 'height=600,width=800');
  w.document.write('<!doctype html><html><head><title>Receipt</title></head><body><pre>');
  w.document.write(els.receipt.textContent.replace(/</g,'&lt;').replace(/>/g,'&gt;'));
  w.document.write('</pre></body></html>');
  w.document.close(); w.focus(); w.print(); w.close();
};

/* Boot */
setAuth();
refreshMe();
</script>
</body>
</html>
